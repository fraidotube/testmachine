from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse
from util.shell import run

router = APIRouter()

def head(title: str) -> str:
    return f"""<!doctype html><html><head><meta charset='utf-8'/>
    <meta name='viewport' content='width=device-width,initial-scale=1'/>
    <title>{title}</title><link rel='stylesheet' href='/static/styles.css'/></head><body>
    <div class='container'><div class='nav'>
      <div class='brand'><img src='/static/img/logo.svg' alt='Logo' class='logo'><span>TestMachine</span></div>
      <div class='links'>
        <a href='/'>Home</a><a href='/wan'>WAN</a><a href='/lan'>LAN</a>
        <a href='/settings'>Impostazioni</a><a href='/smokeping/'>Smokeping</a>
      </div></div>"""

@router.get("/", response_class=HTMLResponse)
def sp_admin_home(request: Request):
    return head("SmokePing Admin") + """
    <div class='grid'>
      <div class='card'>
        <h2>SmokePing Admin</h2>
        <p>Sezione amministrativa minima.
           Qui aggiungeremo gestione target, probes e export.</p>
        <div class='row'>
          <a class='btn' href='/smokeping/'>Apri interfaccia SmokePing</a>
          <a class='btn secondary' href='/sp-admin/targets'>Vedi Targets</a>
          <a class='btn secondary' href='/sp-admin/restart'>Riavvia servizio</a>
        </div>
      </div>
    </div></div></body></html>"""

@router.get("/targets", response_class=HTMLResponse)
def view_targets(request: Request):
    rc, out, err = run(["/bin/cat", "/etc/smokeping/config.d/Targets"])
    body = out if rc == 0 else f"Errore: {err}"
    return head("Targets") + f"<div class='grid'><div class='card'><h2>Targets</h2><pre>{body}</pre><a class='btn secondary' href='/sp-admin/'>Indietro</a></div></div></div></body></html>"

@router.get("/restart", response_class=HTMLResponse)
def restart_smokeping(request: Request):
    rc, out, err = run(["sudo","-n","systemctl","restart","smokeping"])
    msg = "SmokePing riavviato" if rc == 0 else f"Errore riavvio: {err or out}"
    cls = "ok" if rc == 0 else "err"
    return head("Riavvio SmokePing") + f"<div class='grid'><div class='card'><h2 class='{cls}'>{msg}</h2><a class='btn secondary' href='/sp-admin/'>Indietro</a></div></div></div></body></html>"
